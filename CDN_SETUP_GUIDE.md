# CDN Setup Guide for HealthierKE

This guide covers CDN setup options optimized for Kenya and East Africa.

## Recommended CDN Providers for Kenya

### 1. Cloudflare (Recommended)
- **Why**: Global network with Nairobi edge server, free tier available
- **Kenya Performance**: ~20-50ms latency from Nairobi
- **Cost**: Free tier + paid plans from $20/month

#### Cloudflare Setup
1. Sign up at https://cloudflare.com
2. Add your domain
3. Update nameservers
4. Enable these optimizations:
   - Auto Minify (HTML, CSS, JS)
   - Brotli compression
   - Early Hints
   - HTTP/3
   - Image Optimization (Polish)

#### Cloudflare Page Rules
```
# Static assets cache
/*static*
Cache Level: Cache Everything
Browser Cache TTL: 1 year
Edge Cache TTL: 1 month

# Images cache
*.(jpg|jpeg|png|gif|webp|svg|ico)
Cache Level: Cache Everything
Browser Cache TTL: 1 month
Edge Cache TTL: 1 week

# API cache (short-lived)
/api/*
Cache Level: Cache Everything
Browser Cache TTL: 5 minutes
Edge Cache TTL: 1 minute
```

### 2. AWS CloudFront
- **Why**: Excellent global coverage, deep AWS integration
- **Kenya Performance**: ~30-60ms latency
- **Cost**: Pay-as-you-go, ~$0.085/GB in Africa

#### CloudFront Behaviors
```json
{
  "static-assets": {
    "PathPattern": "/_next/static/*",
    "TTL": "31536000",
    "Compress": true,
    "ViewerProtocolPolicy": "redirect-to-https"
  },
  "images": {
    "PathPattern": "*.{jpg,jpeg,png,gif,webp,svg}",
    "TTL": "2592000",
    "Compress": true,
    "ResponseHeadersPolicy": "CORS-with-preflight-and-SecurityHeadersPolicy"
  },
  "api": {
    "PathPattern": "/api/*",
    "TTL": "300",
    "Compress": true,
    "CachePolicyId": "4135ea2d-6df8-44a3-9df3-4b5a84be39ad"
  }
}
```

### 3. Fastly
- **Why**: Edge computing capabilities, good for dynamic content
- **Kenya Performance**: ~40-70ms latency
- **Cost**: Starting at $50/month

### 4. BunnyCDN
- **Why**: Cost-effective, good performance
- **Kenya Performance**: ~50-80ms latency
- **Cost**: Starting at $1/month

## Image Optimization Strategies

### 1. Format Selection
```javascript
// next.config.js - Enhanced image config
const nextConfig = {
  images: {
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    minimumCacheTTL: 31536000, // 1 year
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cdn.healthierke.com',
        pathname: '/**',
      }
    ]
  }
}
```

### 2. Responsive Images
```html
<!-- Automatically generated by OptimizedImage component -->
<picture>
  <source
    srcset="/images/hero-400.webp 400w, /images/hero-800.webp 800w"
    type="image/webp"
    sizes="(max-width: 768px) 100vw, 50vw"
  >
  <source
    srcset="/images/hero-400.jpg 400w, /images/hero-800.jpg 800w"
    type="image/jpeg"
    sizes="(max-width: 768px) 100vw, 50vw"
  >
  <img src="/images/hero-800.jpg" alt="Health illustration" loading="lazy">
</picture>
```

### 3. Image Compression Settings
```bash
# WebP conversion with Sharp
npm install sharp

# Batch convert images
const sharp = require('sharp');

async function convertToWebP(inputPath, outputPath) {
  await sharp(inputPath)
    .webp({ quality: 80, effort: 6 })
    .toFile(outputPath);
}
```

## Performance Headers

### 1. Next.js Security Headers
```javascript
// next.config.js
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  }
];

module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: securityHeaders,
      },
      {
        source: '/static/(.*)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable'
          }
        ]
      }
    ];
  }
};
```

### 2. Service Worker Caching Strategy
```javascript
// Enhanced caching in sw.js
const CACHE_STRATEGIES = {
  images: {
    strategy: 'CacheFirst',
    maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days
    maxEntries: 100
  },
  static: {
    strategy: 'CacheFirst',
    maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days
    maxEntries: 50
  },
  api: {
    strategy: 'NetworkFirst',
    maxAge: 5 * 60 * 1000, // 5 minutes
    maxEntries: 20
  }
};
```

## Kenya-Specific Optimizations

### 1. Mobile-First Design
- Prioritize 3G/4G optimization
- Implement aggressive image compression
- Use skeleton loading for perceived performance

### 2. Offline-First Strategy
```javascript
// Progressive enhancement for connectivity
if ('serviceWorker' in navigator && 'PushManager' in window) {
  // Register enhanced service worker
  navigator.serviceWorker.register('/sw-enhanced.js');
}

// Background sync for form submissions
if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
  navigator.serviceWorker.ready.then(registration => {
    return registration.sync.register('background-sync');
  });
}
```

### 3. Data-Saving Features
```javascript
// Detect slow connections
if ('connection' in navigator) {
  const connection = navigator.connection;
  
  if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
    // Load lower quality images
    // Disable auto-playing videos
    // Defer non-critical resources
  }
}
```

## Implementation Checklist

### Phase 1: Basic CDN Setup
- [ ] Choose CDN provider (Cloudflare recommended)
- [ ] Configure domain and SSL
- [ ] Set up basic caching rules
- [ ] Test performance from Kenya

### Phase 2: Image Optimization
- [ ] Implement WebP/AVIF conversion
- [ ] Set up responsive image generation
- [ ] Configure lazy loading
- [ ] Add image placeholders

### Phase 3: Advanced Optimization
- [ ] Deploy enhanced service worker
- [ ] Implement background sync
- [ ] Add offline page
- [ ] Configure push notifications

### Phase 4: Monitoring
- [ ] Set up performance monitoring
- [ ] Configure alerts for slow performance
- [ ] Monitor Core Web Vitals
- [ ] Track offline usage

## Performance Targets for Kenya

### Core Web Vitals Goals
- **LCP (Largest Contentful Paint)**: < 2.5s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

### Network-Specific Targets
- **3G Performance**: Page loads in < 5s
- **4G Performance**: Page loads in < 3s
- **WiFi Performance**: Page loads in < 2s

### Offline Support
- **Critical pages**: Available offline
- **Form submissions**: Queue when offline
- **Images**: Cached for offline viewing
- **Error handling**: Graceful degradation

## Cost Estimation (Monthly)

### Small Site (< 1TB transfer)
- **Cloudflare**: $0 (Free tier)
- **AWS CloudFront**: ~$85
- **BunnyCDN**: ~$10

### Medium Site (1-5TB transfer)
- **Cloudflare**: $20-100
- **AWS CloudFront**: $85-425
- **BunnyCDN**: $10-50

### Large Site (5TB+ transfer)
- **Cloudflare**: $200+
- **AWS CloudFront**: $425+
- **BunnyCDN**: $50+

*Costs are estimates and may vary based on features and regions.*
